<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" href="https://checkbook.cash/favicon.svg">
<script src="/app/ethers-5.4.6.umd.min.js" type="application/javascript"></script>
<script src="/app/detect-provider.min.js"></script>
<title>CheckBook Airdrop</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
<style>
        input {
            width: 24px;
            height: 24px;
        }

	code {overflow-wrap: break-word;}

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0, 0, 0); /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
	    border-radius: 8px;
            background-color: #fefefe;
            margin: 35% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 350px;
        }

        /* The Close Button */
        .close {
            color: #91cdb5;
            float: right;
            font-size: 22px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #3fc388;
            text-decoration: none;
            cursor: pointer;
        }

</style>
</head>
<body style="margin: 0 auto; width: 360px">
<center>
<br>
<p data-CN>每位符合要求的用户，将获得包含价值5美元<a target="_blank" href="https://brucelee.cash/2021/09/06/cats">$CATS</a>的支票空投。</p>
<p data-EN>Each qualified account, will be airdropped with a <a target="_blank" href="https://brucelee.cash/2021/09/06/cats">$CATS</a> check with value of $5.</p>

<p style="font-size: 6px">&nbsp;</p>
<button id="checkBtn" class="button is-info" onclick="checkQualified()" data-T>Can I get airdropped?//我能获得空投吗？</button>
<p id="loadingP" style="display: none"><img src="/loading.gif"/></p>
<p id="yesP" style="display: none"><img src="/BoxOpenWithCat.gif"/></p>
<p id="noP" style="display: none"><img src="/BoxOpenWithoutCat.gif"/></p>
</center>

<div id="switchChain" style="display: none">
<p data-EN><br>You wallet is not connecting to smartBCH. If you have never added smart BCH to your wallet, please click the following button to add it. If you have added it before, please switch to smartBCH and then <a href="javascript:location.reload()">reload</a> this page.</p>
<p data-CN><br>您的钱包并未连接到smartBCH链。如果您从未将smartBCH加入您的钱包，请点击下面的按钮来添加。如果您已经添加过了，请切换到smartBCH链，然后<a href="javascript:location.reload()">刷新</a>本页面。</p>
<p style="text-align: center"><button class="button is-small" onclick="addSmartBCH()" data-T>
Add smartBCH to Wallet//将smartBCH加入钱包</button></p>
</div>

<div id="moreInfo" style="display: none">

<p><span data-T>Your current account's address is://您当前的账户地址为：</span>
<span id="myAddr" style="font-size: 14px"></span></p>

<div id="isQualified" style="display: none">
   <br>
   <p data-CN>恭喜！您的当前账户符合活动要求。支票已经发送给您，请一分钟后在<a target="_blank" href="https://checkbook.cash/app?autolist=1">支票DApp</a>中接收。</p>
   <p data-EN>Congratulations! Your current account can get airdrop! The check has been sent to you, please accept it in <a target="_blank" href="https://checkbook.cash/app?autolist=1">the CheckBook DApp</a> after a minute.</p>

   <div id="getBCH" style="display: none">
      <br>
      <p data-CN>领取支票是链上操作，需要消耗价值约为5美分的BCH作为gas费。经检测，您账户中BCH的余额为零，请先通过<a target="_blank" href="https://bchcc.cash">bchcc.cash</a>将一些主链BCH跨到smartBCH链上。</p>
      <p data-EN>The balance of your account is still 0 BCH, which means you cannot send the transaction to accept check. Please use <a target="_blank" href="https://bchcc.cash">bchcc.cash</a> to transfer some BCH from the main chain to smartBCH side chain, to pay the gas fee for accepting the check, whose value is about $0.05.</p>
   </div>
</div>

<div id="notQualified" style="display: none">
   <br>
   <p data-CN>很遗憾，您不符合本次活动要求。但是您依旧可以参与<a target="_blank" href="https://bchcc.cash">bchcc.cash</a>入金获赠支票的活动，只要充值大于0.0002个BCH（折合0.13美元），即可获得一张包含随机数量$CATS的支票，最高可以达到2000 $CATS。</p>
   <p data-EN>Sorry, but your current account is not qualified for this airdrop. However, your can still get check with free $CATS by transferring BCH onto the smartBCH side chain through <a target="_blank" href="https://bchcc.cash">bchcc.cash</a>. As long as the transferred amount is larger than 0.0002BCH (about $0.13), you can get a check with random $CATS, which can be as high as 2000.</p>
</div>

<div id="referDIV" style="display: none">
   <br>
   <p data-CN>您还可以推荐其他人来领取空投，如果有其他人通过您的推荐链接成功领取了5美元的支票，您将获得价值1美元$CATS的奖励（每天结算一次）。</p>
   <p data-EN>Besides, anyone can refer checkbook.cash to other people. And if a qualified account accepts its $CATS check by following a refer link, the referer will be rewarded with $CATS of value of $1. The rewards are settled once in a day.</p>
   
   <p><span data-T>Your refer link is://您的推荐链接为：</span><a id="referLink"></a></p>
   
   <p data-CN>推荐奖励使用支票形式发送，您可以在<a target="_blank" href="https://checkbook.cash/app?autolist=1">支票DApp</a>中查看您是否获得了推荐奖励。</p>
   <p data-EN>The referer's reward is also delivered through checks. You can use <a target="_blank" href="https://checkbook.cash/app?autolist=1">the checkbook DApp</a> to discover the rewards to you.</p>
</div>

<hr>

<center><a target="_blank" href="https://brucelee.cash/2021/11/16/after-cats-airdrop"
	data-T>What can I do with the airdropped $CATS?//领到空投的$CATS之后可以做什么？</a></center>
<center><img style="width: 120px; height: auto;" src="/cashcats.png"></center>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
        <p id="modalContent" style="text-align: center; overflow-wrap: break-word"></p>
        <span class="close">&nbsp;&nbsp;&nbsp;&nbsp;OK</span>
    </div>
</div>

<script>
function hexToReferID(hex) {
  var res = ""
  const table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-"
  for (var i = 0; i < hex.length; i+=2) {
    const n = parseInt(hex.substr(i, 2), 16)
    if(isNaN(n)) {return null}
    res += table[n%64]
  }
  return res
}

function compareAddr(a, b) {
	for(var i=0; i<20; i++) {
		if(a[i] > b[i]) {
			return 1
		} else if(a[i] < b[i]) {
			return -1
		}
	}
	return 0
}

function getAddrFromArray(addrArr, index) {
	return addrArr.slice(index*20, index*20+20)
}

function binarySearch(addrArr, myAddr) {
	let start=0, end=(addrArr.length/20)-1
	
	//for(var i=start; i<=end; i++) {
	//	console.log("here", getAddrFromArray(addrArr, i))
	//}
         
	// Iterate while start not meets end
	while(start<=end) {
		// Find the mid index
		let mid=Math.floor((start + end)/2)


		let cmpResult = compareAddr(getAddrFromArray(addrArr, mid), myAddr)
		//console.log("why", start, mid, end, cmpResult)
		// If element is present at mid, return True
		if(cmpResult==0) {
			return true
		// Else look in left or right half accordingly
		} else if (cmpResult<0) {
			start = mid + 1;
		} else {
			end = mid - 1;
		}
	}
	return false;
}

async function getAddrArr(url) {
	let response = await fetch(url)
	let blob = await response.blob()
	let buffer = await blob.arrayBuffer()
	return new Uint8Array(buffer)
}

async function checkQualified() {
	var ok = await connect()
	if(!ok) return
	document.getElementById("checkBtn").disabled = true
	document.getElementById("loadingP").style.display = "block"
	document.getElementById("yesP").style.display = "none"
	document.getElementById("noP").style.display = "none"
	const provider = new ethers.providers.Web3Provider(window.ethereum)
	const signer = provider.getSigner()
	const myAddr = await signer.getAddress()
	console.log("myAddr", myAddr)
	document.getElementById("myAddr").innerText = myAddr
	var referLink =  document.getElementById("referLink")
	var link = "https://checkbook.cash/airdrop?r="+hexToReferID(myAddr.substr(2,26))
	referLink.innerText = link
	referLink.href = link
	referLink.target = "_blank"

	var n = ethers.BigNumber.from(myAddr.substr(0, 8)).toNumber()
	var targetNum = n%2048
	console.log("targetNum", targetNum)
	var addrArr = await getAddrArr(`./addr_dat/addr_list.${targetNum}.dat`)
	ok = binarySearch(addrArr, ethers.utils.arrayify(myAddr))
	document.getElementById("loadingP").style.display = "none"
	if(!ok) {
		document.getElementById("noP").style.display = "block"
		document.getElementById("notQualified").style.display = "block"
		document.getElementById("referDIV").style.display = "block"
		document.getElementById("moreInfo").style.display = "block"
		return
	}
	const network = await provider.getNetwork();
	if(network.chainId != 10000) {
		document.getElementById("switchChain").style.display = "block"
		return
	}
	document.getElementById("checkBtn").disabled = false

	if(localStorage.getItem("airdrop-"+myAddr) !== "yes") {
		const message = "I want free $CATS!"
		const signature = await signer.signMessage(message)
		const response = await fetch(`https://moeing.dev/q/${myAddr}/${signature}`)
		const respJson = await response.json()
		if(respJson.err !== null) {
			myAlert(T("Server returns error://服务器返回错误：")+respJson.err)
			return
		}
		localStorage.setItem("airdrop-"+myAddr, "yes")
	}
	document.getElementById("yesP").style.display = "block"
	document.getElementById("isQualified").style.display = "block"
	document.getElementById("moreInfo").style.display = "block"
	const balance = await provider.getBalance(myAddr)
	if(balance.isZero()) {
		document.getElementById("getBCH").style.display = "block"
	} else {
		document.getElementById("referDIV").style.display = "block"
	}
}

async function connect() {
	if (typeof window.ethereum === 'undefined') {
		if (typeof window.web3 !== 'undefined') {
			window.ethereum = window.web3;
		} else if (typeof window.TPJSBrigeClient !== 'undefined') {
			window.ethereum = window.TPJSBrigeClient;
		} else if (typeof window.imToken !== 'undefined') {
			window.ethereum = window.imToken;
		} else {
			const provider = await detectEthereumProvider();
			if (provider) {
				window.ethereum = provider;
			} else if(IsPC()) {
				myAlert(T("Your browser has not installed a wallet extension (like MetaMask).//您的浏览器尚未安装钱包扩展（例如MetaMask）。"));
			} else {
				myAlert(T("Please open this page inside a mobile wallet App.//请使用钱包APP内置浏览器打开本页面。"));
			}
		}
	}
	window.accounts = await window.ethereum.request({method: "eth_requestAccounts"});
	if (window.accounts.length == 0) {
		myAlert(T("Cannot connect to wallet//钱包连接失败"));
		return false;
	}
	return true;
}

// Add the smartBCH chain to a web3 wallet
async function addSmartBCH() {
	const err = await window.ethereum.request({
	  method: 'wallet_addEthereumChain',
	  params: [{
	    "chainId": "0x2710",
	    "chainName": "smartBCH",
	    "rpcUrls": ["https://smartbch.fountainhead.cash/mainnet"],
	    "nativeCurrency": {
	      "name": "smart BCH",
	      "symbol": "BCH",
	      "decimals": 18
	    },
	    "blockExplorerUrls": ["https://www.smartscan.cash"]
	  }],
	});
	if(err !== null) {
		myAlert(T("Failed to add smartBCH to your wallet. Please add it manually by following this guide://无法将smartBCH链添加到您的钱包。请参考此文章手动添加：")+"https://brucelee.cash/2021/08/31/newbie/");
	}
	location.reload()
}

function myAlert(text) {
	document.getElementById("myModal").style.display = "block";
	document.getElementById("modalContent").innerText = text;
}

window.addEventListener('DOMContentLoaded', async (event) => {
	// Get the modal
	var modal = document.getElementById("myModal");

	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];

	// When the user clicks on <span> (x), close the modal
	span.onclick = function () {
	    modal.style.display = "none";
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event) {
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}

	const url = new URL(location.href);
	const referID = url.searchParams.get("r")
	if(referID) {
		localStorage.setItem("referID", referID)
	}
		
	window.LANG = "en";
	if(url.searchParams.get("lang") == "cn") {
		window.LANG = "cn";
	} else if (url.searchParams.get("lang") == "en") {
		window.LANG = "en";
	} else if (navigator.language.startsWith("zh")) {
		window.LANG = "cn";
	}
	var elems = document.querySelectorAll('*[data-T]');
	for (var i = 0; i < elems.length; i++) {
		elems[i].innerText = T(elems[i].innerText);
	}
	if(window.LANG == "en") { // hide Chinese
		var elems = document.querySelectorAll('*[data-CN]');
		for (var i = 0; i < elems.length; i++) {
			elems[i].style.display = "none";
		}
	}
	if(window.LANG == "cn") { // hide English
		var elems = document.querySelectorAll('*[data-EN]');
		for (var i = 0; i < elems.length; i++) {
			elems[i].style.display = "none";
		}
	}
})

// Select the English version of Chinese version of a text
function T(text) {
	try {
		const twoStr = text.split("//");
		if (window.LANG === "cn") {
		    return twoStr[1];
		}
		return twoStr[0];
	} catch (e) {
		return text;
	}
}

function IsPC() {
       var userAgentInfo = navigator.userAgent;
       var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");
       var flag = true;
       for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
             }
       }
       return flag;
}

if(IsPC()) {
   document.body.style.zoom = 1.36;
}
</script>
</body>
</html>
